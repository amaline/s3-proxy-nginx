machine:
  environment:
    NXVERSION: 1.11.4
    NXURL: http://nginx.org/download/nginx-1.11.4.tar.gz
    NXAUTHMODULEREP: https://github.com/amaline/ngx_aws_auth.git
    GITHUB_PROJECT: amaline/s3-proxy-nginx
    PROJECT_REPOSITORY: github.com/amaline/s3-proxy-nginx.git
    GITHUB_RELEASE: v0.4
    ARTIFACT_NAME: nginx-s3.tgz

dependencies:
   override:
    - sudo apt-get -y install curl build-essential libpcre3 libpcre3-dev zlib1g-dev libssl-dev jq
    - curl -LO ${NXURL}
    - tar zxf nginx-${NXVERSION}.tar.gz 
    - cd nginx-${NXVERSION} && git clone ${NXAUTHMODULEREP} 
    - cd nginx-${NXVERSION} && ./configure --with-http_ssl_module --add-module=ngx_aws_auth
    - cd nginx-${NXVERSION} && make 
    - mkdir nginx && mkdir nginx/conf && mkdir nginx/logs && mkdir nginx/sbin 
    - cp nginx-${NXVERSION}/objs/nginx nginx/sbin
    - echo '---' >> sources.yml
    - echo -n '- url:' >> sources.yml
    - echo ' '${NXURL} >> sources.yml
    - echo -n '  sha256:' >> sources.yml
    - echo -n ' ' >> sources.yml
    - sha256sum nginx-${NXVERSION}.tar.gz | cut -f 1 -d ' ' >> sources.yml
    - tar cvzf ${CIRCLE_ARTIFACTS}/${ARTIFACT_NAME} sources.yml nginx
    - chmod +x ./deploy.sh
    
database:
  override:
   - nginx/sbin/nginx -p `pwd`/ -c test.conf
   
test:
  override:
     - diff -q <(curl -s http://localhost:4945/) index.html


deployment:
  hub:
    branch: master
    commands:
       - ./deploy.sh
