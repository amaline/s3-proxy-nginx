machine:
  environment:
    NXVERSION: 1.11.4
    NXURL: http://nginx.org/download/nginx-1.11.4.tar.gz
    NXAUTHMODULEREP: https://github.com/amaline/ngx_aws_auth.git
    GITHUB_PROJECT: amaline/s3-proxy-nginx
    PROJECT_REPOSITORY: github.com/amaline/s3-proxy-nginx.git
    GITHUB_RELEASE: 0.1

dependencies:
   override:
    - sudo apt-get -y install curl build-essential libpcre3 libpcre3-dev zlib1g-dev libssl-dev  
    - curl -LO ${NXURL}
    - tar zxf nginx-${NXVERSION}.tar.gz 
    - cd nginx-${NXVERSION} && git clone ${NXAUTHMODULEREP} 
    - cd nginx-${NXVERSION} && ./configure --with-http_ssl_module --add-module=ngx_aws_auth
    - cd nginx-${NXVERSION} && make 
    - mkdir nginx && mkdir nginx/conf && mkdir nginx/logs && mkdir nginx/sbin 
    - cp nginx-${NXVERSION}/objs/nginx nginx/sbin
    - echo '---' >> sources.yml
    - echo -n '- url:' >> sources.yml
    - echo ' '${NXURL} >> sources.yml
    - echo -n '  sha256:' >> sources.yml
    - echo -n ' ' >> sources.yml
    - sha256sum nginx-${NXVERSION}.tar.gz | cut -f 1 -d ' ' >> sources.yml
    - tar cvf ${CIRCLE_ARTIFACTS}/nginx-s3.tar sources.yml nginx
    
database:
  override:
   - nginx/sbin/nginx -p `pwd`/ -c test.conf
   
test:
  override:
     - diff -q <(curl -s http://localhost:4945/) index.html


deployment:
  hub:
    branch: master
    commands:
       - git tag $GITHUB_RELEASE
       - git push https://${GITHUB_TOKEN}:@${PROJECT_REPOSITORY} --tags
       - echo {"tag_name":"${GITHUB_RELEASE}","target_commitish":"master","name":"CircleCI s3-proxy-nginx build process","body":"Release of nginx compiled version for custom cloud foundry buildpack","draft":false,"prerelease":true} > json.json
       - curl -# -XPOST -H 'Content-Type:application/json' -H 'Accept:application/json' --data-binary @json.json https://api.github.com/repos/${GITHUB_PROJECT}/releases?access_token=${GITHUB_TOKEN} -o response.json
       - cp response.json ${CIRCLE_ARTIFACTS}
       - curl -# -XPOST -H "Authorization:${GITHUB_TOKEN}" -H "Content-Type:application/octet-stream" --data-binary @${CIRCLE_ARTIFACTS}/nginx-s3.tar https://uploads.github.com/repos/${GITHUB_PROJECT}/releases/%id_release%/assets?name=yourbinary.exe
